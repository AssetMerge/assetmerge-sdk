import { BigNumber, Contract, utils } from 'ethers';
import { getAddress } from 'ethers/lib/utils';
import { MULTCALL2_ADDRESS } from '../constants';
import { ERC721Interface, ERC721PoolInterface, Multicall2Interface, } from '../interfaces';
export const getBalance = async (token, address, provider, liquidityPool = null) => {
    try {
        const [inTransfers, outTransfers] = await Promise.all([
            provider.getLogs({
                address: token.address,
                fromBlock: 0,
                topics: [
                    utils.id('Transfer(address,address,uint256)'),
                    null,
                    utils.hexZeroPad(address, 32),
                ],
            }),
            provider.getLogs({
                address: token.address,
                fromBlock: 0,
                topics: [
                    utils.id('Transfer(address,address,uint256)'),
                    utils.hexZeroPad(address, 32),
                ],
            }),
        ]);
        const count = {};
        inTransfers.forEach((log) => {
            const { tokenId } = ERC721Interface.decodeEventLog('Transfer', log.data, log.topics);
            const id = tokenId.toString();
            if (count[id])
                count[id] = count[id] + 1;
            else
                count[id] = 1;
        });
        outTransfers.forEach((log) => {
            const { tokenId } = ERC721Interface.decodeEventLog('Transfer', log.data, log.topics);
            const id = tokenId.toString();
            if (count[id])
                count[id] = count[id] - 1;
        });
        const historicalIds = [
            ...new Set(Object.keys(count).filter((id) => count[id] > 0)),
        ].map((idString) => BigNumber.from(idString));
        const multicall = new Contract(MULTCALL2_ADDRESS, Multicall2Interface, provider);
        const ownerCalls = historicalIds.map((id) => ({
            target: token.address,
            callData: ERC721Interface.encodeFunctionData('ownerOf', [id]),
        }));
        const ownerReturnData = await multicall.callStatic.aggregate(ownerCalls);
        const ids = ownerReturnData[1]
            .map((data, index) => ({
            id: historicalIds[index],
            owner: ERC721Interface.decodeFunctionResult('ownerOf', data)[0],
        })).filter((item) => getAddress(item.owner) === getAddress(address))
            .map((item) => item.id);
        const uriCalls = ids.map((id) => ({ target: token.address, callData: ERC721Interface.encodeFunctionData('tokenURI', [id]) }));
        const uris = await multicall.callStatic.aggregate(uriCalls);
        if (liquidityPool) {
            const weightCalls = ids.map((id) => ({
                target: liquidityPool,
                callData: ERC721PoolInterface.encodeFunctionData('getNFTWeight', [
                    id,
                ]),
            }));
            const weightResult = await multicall.callStatic.aggregate(weightCalls);
            const items = ids.map((id, index) => {
                const uri = ERC721Interface.decodeFunctionResult('tokenURI', uris[1][index])[0];
                const weight = ERC721PoolInterface.decodeFunctionResult('getNFTWeight', weightResult[index])[0];
                return { id, uri, weight };
            });
            return items;
        }
        else {
            const items = ids.map((id, index) => {
                const uri = ERC721Interface.decodeFunctionResult('tokenURI', uris[1][index])[0];
                return { id, uri };
            });
            return items;
        }
    }
    catch (error) {
        throw error;
    }
};
export const createBalanceManager = (token, address, provider, liquidityPool = null, updateCallback) => new Promise(async (resolve, reject) => {
    try {
        const items = await getBalance(token, address, provider, liquidityPool);
        resolve(new BalanceManager(token, address, provider, liquidityPool, items, updateCallback ?? null));
    }
    catch (error) {
        reject(error);
    }
});
export class BalanceManager {
    token;
    address;
    _nft;
    _liquidityPool;
    _liquidityPoolAddr;
    items;
    updateCallback;
    provider;
    constructor(token, address, provider, liquidityPool = null, items, updateCallback) {
        this.token = token;
        this.items = items;
        this.address = getAddress(address);
        this.provider = provider;
        this.updateCallback = updateCallback ?? null;
        this._nft = new Contract(token.address, ERC721Interface, provider);
        if (liquidityPool) {
            this._liquidityPool = new Contract(liquidityPool, ERC721PoolInterface, provider);
            this._liquidityPoolAddr = liquidityPool;
        }
        this.provider.on({
            address: this.token.address,
            topics: [
                utils.id("Transfer(address,address,uint256)"),
                null,
                utils.hexZeroPad(this.address, 32)
            ]
        }, async (log) => {
            const { to, tokenId } = ERC721Interface.decodeEventLog('Transfer', log.data, log.topics);
            let weight;
            if (this._liquidityPoolAddr) {
                weight = await this._liquidityPool.getNFTWeight(tokenId);
            }
            const uri = this._nft.tokenURI(tokenId);
            if (to === this.address && this.items.findIndex((item) => item.id.eq(tokenId)) < 0) {
                if (weight)
                    this.items.push({ id: tokenId, weight, uri });
                else
                    this.items.push({ id: tokenId, uri });
            }
            else if (this._liquidityPoolAddr) {
                this.items[this.items.findIndex((item) => item.id.eq(tokenId))].weight = weight;
            }
            if (this.updateCallback)
                this.updateCallback(this.items);
        });
        this.provider.on({
            address: this.token.address,
            topics: [
                utils.id("Transfer(address,address,uint256)"),
                utils.hexZeroPad(this.address, 32)
            ]
        }, async (log) => {
            const { from, tokenId } = ERC721Interface.decodeEventLog('Transfer', log.data, log.topics);
            if (from === this.address && this.items.findIndex((item) => item.id.eq(tokenId)) >= 0) {
                this.items.splice(this.items.findIndex((item) => item.id.eq(tokenId)), 1);
            }
            if (this.updateCallback)
                this.updateCallback(this.items);
        });
    }
    stopUpdates() {
        this.provider.removeAllListeners();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5CYWxhbmNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvcG9vbHMvdG9rZW5CYWxhbmNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFhLFFBQVEsRUFBYSxLQUFLLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDMUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUVqRCxPQUFPLEVBQ0wsZUFBZSxFQUNmLG1CQUFtQixFQUNuQixtQkFBbUIsR0FDcEIsTUFBTSxlQUFlLENBQUM7QUFHdkIsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLEtBQUssRUFDN0IsS0FBYSxFQUNiLE9BQWUsRUFDZixRQUE0QixFQUM1QixnQkFBd0IsSUFBSSxFQUNMLEVBQUU7SUFDekIsSUFBSTtRQUNGLE1BQU0sQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ3BELFFBQVEsQ0FBQyxPQUFPLENBQUM7Z0JBQ2YsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixTQUFTLEVBQUUsQ0FBQztnQkFDWixNQUFNLEVBQUU7b0JBQ04sS0FBSyxDQUFDLEVBQUUsQ0FBQyxtQ0FBbUMsQ0FBQztvQkFDN0MsSUFBSTtvQkFDSixLQUFLLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7aUJBQzlCO2FBQ0YsQ0FBQztZQUNGLFFBQVEsQ0FBQyxPQUFPLENBQUM7Z0JBQ2YsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixTQUFTLEVBQUUsQ0FBQztnQkFDWixNQUFNLEVBQUU7b0JBQ04sS0FBSyxDQUFDLEVBQUUsQ0FBQyxtQ0FBbUMsQ0FBQztvQkFDN0MsS0FBSyxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsRUFB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